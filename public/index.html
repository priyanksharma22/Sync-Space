<!-- public/index.html (Corrected to handle null references) -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SyncSpace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-approved { background-color: #d1fae5; color: #065f46; }
        .status-rejected { background-color: #fee2e2; color: #991b1b; }
    </style>
</head>
<body class="bg-gray-50">
    <nav class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex-shrink-0 flex items-center">
                    <h1 class="text-2xl font-bold text-blue-600">SyncSpace</h1>
                </div>
                <div class="flex items-center">
                    <span id="welcomeMessage" class="text-gray-700 mr-4"></span>
                    <button id="logoutButton" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Rooms Section -->
        <div class="px-4 py-6 sm:px-0">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Available Rooms</h2>
            <div id="roomsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <!-- Booking Form Modal -->
        <div id="bookingModal" class="fixed z-10 inset-0 overflow-y-auto hidden">
            <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 transition-opacity" aria-hidden="true"><div class="absolute inset-0 bg-gray-500 opacity-75"></div></div>
                <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                    <form id="bookingForm" class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4" id="modalTitle">Book a Room</h3>
                        <input type="hidden" id="roomId" name="roomId">
                        <div class="mb-4">
                            <label for="date" class="block text-sm font-medium text-gray-700">Date</label>
                            <input type="date" name="date" id="date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div class="mb-4">
                            <label for="startTime" class="block text-sm font-medium text-gray-700">Start Time</label>
                            <input type="time" name="startTime" id="startTime" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div class="mb-4">
                            <label for="endTime" class="block text-sm font-medium text-gray-700">End Time</label>
                            <input type="time" name="endTime" id="endTime" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div id="modalErrorMessage" class="text-red-500 text-sm mt-2 text-center"></div>
                    </form>
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button type="submit" form="bookingForm" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">Submit Request</button>
                        <button type="button" id="closeModalButton" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- My Bookings Section -->
        <div class="px-4 py-6 sm:px-0">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">My Bookings</h2>
            <div id="myBookingsContainer" class="bg-white shadow overflow-hidden sm:rounded-md">
                <ul class="divide-y divide-gray-200"></ul>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="hidden px-4 py-6 sm:px-0">
            <div class="border-4 border-dashed border-gray-200 rounded-lg p-4">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Admin Panel</h2>
                <div class="mb-8">
                    <h3 class="text-xl font-medium text-gray-700 mb-3">Add a New Room</h3>
                    <form id="addRoomForm" class="bg-white p-4 rounded-lg shadow-sm grid grid-cols-1 gap-4 sm:grid-cols-3">
                        <div>
                            <label for="roomName" class="block text-sm font-medium text-gray-700">Room Name</label>
                            <input type="text" id="roomName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label for="capacity" class="block text-sm font-medium text-gray-700">Capacity</label>
                            <input type="number" id="capacity" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div class="sm:col-span-3">
                            <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                            <textarea id="description" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                        </div>
                        <button type="submit" class="sm:col-start-3 justify-self-end bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Add Room</button>
                    </form>
                </div>

                <!-- Tabbed Interface for Bookings -->
                <div>
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <button id="pendingTab" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600">Pending</button>
                            <button id="approvedTab" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Approved</button>
                            <button id="rejectedTab" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Rejected</button>
                        </nav>
                    </div>
                    <div class="mt-4">
                        <div id="pendingContent" class="tab-content"><ul id="pendingBookingsContainer" class="bg-white shadow-md rounded-md divide-y divide-gray-200"></ul></div>
                        <div id="approvedContent" class="tab-content hidden"><ul id="approvedBookingsContainer" class="bg-white shadow-md rounded-md divide-y divide-gray-200"></ul></div>
                        <div id="rejectedContent" class="tab-content hidden"><ul id="rejectedBookingsContainer" class="bg-white shadow-md rounded-md divide-y divide-gray-200"></ul></div>
                    </div>
                </div>
            </div>
        </div>
        <div id="message" class="text-center mt-4"></div>
    </main>

    <script>
        const token = localStorage.getItem('token');
        const messageDiv = document.getElementById('message');

        function parseJwt(token) { try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; } }
        function formatDate(dateString) { const options = { year: 'numeric', month: 'long', day: 'numeric' }; return new Date(dateString).toLocaleDateString(undefined, options); }

        async function apiRequest(url, method = 'GET', body = null) {
            const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };
            const options = { method, headers };
            if (body) { options.body = JSON.stringify(body); }
            const response = await fetch(url, options);
            if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.message || `HTTP error! status: ${response.status}`); }
            return response.json();
        }

        function showMessage(text, isError = false) {
            messageDiv.textContent = text;
            messageDiv.className = `text-center mt-4 ${isError ? 'text-red-500' : 'text-green-500'}`;
            setTimeout(() => messageDiv.textContent = '', 3000);
        }

        window.addEventListener('DOMContentLoaded', () => {
            if (!token) { window.location.href = '/login.html'; return; }
            const user = parseJwt(token);
            if (!user) { localStorage.removeItem('token'); window.location.href = '/login.html'; return; }

            document.getElementById('welcomeMessage').textContent = `Welcome, ${user.role}!`;
            document.getElementById('logoutButton').addEventListener('click', () => { localStorage.removeItem('token'); window.location.href = '/login.html'; });

            loadRooms();
            loadUserBookings();

            if (user.role === 'admin') {
                document.getElementById('adminPanel').classList.remove('hidden');
                loadAllBookings();
                setupTabs();
            }
        });

        async function loadRooms() {
            try {
                const rooms = await apiRequest('/api/rooms');
                const roomsContainer = document.getElementById('roomsContainer');
                roomsContainer.innerHTML = '';
                rooms.forEach(room => {
                    roomsContainer.innerHTML += `
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold text-gray-900">${room.name}</h3>
                            <p class="text-gray-600 mt-2">Capacity: ${room.capacity}</p>
                            <p class="text-gray-500 mt-1">${room.description}</p>
                            <button onclick="openBookingModal('${room._id}', '${room.name}')" class="mt-4 w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Book Now</button>
                        </div>`;
                });
            } catch (error) { showMessage(`Error loading rooms: ${error.message}`, true); }
        }

        async function loadUserBookings() {
            try {
                const bookings = await apiRequest('/api/bookings/my-bookings');
                const myBookingsContainer = document.getElementById('myBookingsContainer').querySelector('ul');
                myBookingsContainer.innerHTML = '';
                if (bookings.length === 0) {
                    myBookingsContainer.innerHTML = '<li class="px-6 py-4">You have no bookings.</li>';
                    return;
                }
                bookings.forEach(booking => {
                    // ** THE FIX ** Add a safety check here as well
                    if (booking.roomId) {
                        myBookingsContainer.innerHTML += `
                            <li class="px-6 py-4 flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-indigo-600">${booking.roomId.name}</p>
                                    <p class="text-sm text-gray-500">${formatDate(booking.date)} from ${booking.startTime} to ${booking.endTime}</p>
                                </div>
                                <div class="flex items-center">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full status-${booking.status}">${booking.status}</span>
                                </div>
                            </li>`;
                    }
                });
            } catch (error) { showMessage(`Error loading your bookings: ${error.message}`, true); }
        }

        function getAdminButtons(booking) {
            let buttons = '';
            if (booking.status === 'pending') {
                buttons = `<button onclick="updateBookingStatus('${booking._id}', 'approved')" class="bg-green-100 text-green-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded hover:bg-green-200">Approve</button>
                           <button onclick="updateBookingStatus('${booking._id}', 'rejected')" class="bg-red-100 text-red-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded hover:bg-red-200">Reject</button>`;
            } else if (booking.status === 'approved') {
                buttons = `<button onclick="updateBookingStatus('${booking._id}', 'rejected')" class="bg-red-100 text-red-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded hover:bg-red-200">Reject</button>`;
            } else if (booking.status === 'rejected') {
                buttons = `<button onclick="updateBookingStatus('${booking._id}', 'approved')" class="bg-green-100 text-green-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded hover:bg-green-200">Approve</button>`;
            }
            return `<div class="mt-2 text-right">${buttons}</div>`;
        }

        async function loadAllBookings() {
            try {
                const bookings = await apiRequest('/api/bookings');
                const renderBookings = (container, bookingList, emptyMessage) => {
                    container.innerHTML = '';
                    if (bookingList.length === 0) {
                        container.innerHTML = `<li class="px-6 py-4">${emptyMessage}</li>`;
                        return;
                    }
                    bookingList.forEach(booking => {
                        // ** THE FIX ** Add a safety check here. If the user or room for a booking has been deleted,
                        // this `if` statement will prevent the code from crashing.
                        if (booking.roomId && booking.userId) {
                            container.innerHTML += `
                                <li class="px-6 py-4">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm font-medium text-gray-900">${booking.roomId.name} booked by ${booking.userId.name}</p>
                                            <p class="text-sm text-gray-500">${formatDate(booking.date)} from ${booking.startTime} to ${booking.endTime}</p>
                                        </div>
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full status-${booking.status}">${booking.status}</span>
                                    </div>
                                    ${getAdminButtons(booking)}
                                </li>`;
                        }
                    });
                };
                renderBookings(document.getElementById('pendingBookingsContainer'), bookings.filter(b => b.status === 'pending'), 'No pending requests.');
                renderBookings(document.getElementById('approvedBookingsContainer'), bookings.filter(b => b.status === 'approved'), 'No approved bookings.');
                renderBookings(document.getElementById('rejectedBookingsContainer'), bookings.filter(b => b.status === 'rejected'), 'No rejected bookings.');
            } catch (error) { 
                console.error("Error loading all bookings:", error); // Log the full error for debugging
                showMessage(`Error loading all bookings. Check the console for details.`, true); 
            }
        }

        const bookingModal = document.getElementById('bookingModal');
        const modalErrorMessage = document.getElementById('modalErrorMessage');
        function openBookingModal(roomId, roomName) {
            document.getElementById('roomId').value = roomId;
            document.getElementById('modalTitle').textContent = `Book Room: ${roomName}`;
            modalErrorMessage.textContent = '';
            bookingModal.classList.remove('hidden');
        }
        document.getElementById('closeModalButton').addEventListener('click', () => { bookingModal.classList.add('hidden'); });
        document.getElementById('bookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const roomId = document.getElementById('roomId').value;
            const date = document.getElementById('date').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            try {
                await apiRequest('/api/bookings', 'POST', { roomId, date, startTime, endTime });
                showMessage('Booking request submitted successfully!', false);
                bookingModal.classList.add('hidden');
                loadUserBookings();
                if (parseJwt(token).role === 'admin') loadAllBookings();
            } catch (error) { modalErrorMessage.textContent = error.message; }
        });

        document.getElementById('addRoomForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('roomName').value;
            const capacity = document.getElementById('capacity').value;
            const description = document.getElementById('description').value;
            try {
                await apiRequest('/api/rooms', 'POST', { name, capacity, description });
                showMessage('Room added successfully!', false);
                document.getElementById('addRoomForm').reset();
                loadRooms();
            } catch (error) { showMessage(`Failed to add room: ${error.message}`, true); }
        });

        async function updateBookingStatus(bookingId, status) {
            try {
                await apiRequest(`/api/bookings/${bookingId}/status`, 'PUT', { status });
                showMessage(`Booking ${status} successfully!`, false);
                loadAllBookings();
                loadUserBookings();
            } catch (error) { showMessage(`Failed to update status: ${error.message}`, true); }
        }

        function setupTabs() {
            const tabs = [
                { button: document.getElementById('pendingTab'), content: document.getElementById('pendingContent') },
                { button: document.getElementById('approvedTab'), content: document.getElementById('approvedContent') },
                { button: document.getElementById('rejectedTab'), content: document.getElementById('rejectedContent') }
            ];
            const activeClasses = 'border-blue-500 text-blue-600';
            const inactiveClasses = 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300';

            tabs.forEach(tab => {
                tab.button.addEventListener('click', () => {
                    tabs.forEach(t => {
                        t.button.className = `whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${inactiveClasses}`;
                        t.content.classList.add('hidden');
                    });
                    tab.button.className = `whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${activeClasses}`;
                    tab.content.classList.remove('hidden');
                });
            });
        }
    </script>
</body>
</html>

